{% extends 'pharmacy/base.html' %}
{% block title %}Medicines — PharmaFlow{% endblock %}
{% block page_title %}Medicines{% endblock %}

{% block header_actions %}
  <a href="{% url 'medicine_add' %}" class="btn btn-primary btn-sm">
    <i class="bi bi-plus-lg"></i> Add Medicine
  </a>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card mb-3">
  <div class="card-body" style="padding:1rem 1.25rem;">
    <form method="GET" class="row g-2 align-items-end">
      <div class="col-sm-5 col-lg-4">
        <label class="form-label">Search</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Medicine name or category…">
      </div>
      <div class="col-sm-4 col-lg-3">
        <label class="form-label">Category</label>
        <select name="category" class="form-select">
          <option value="">All Categories</option>
          {% for val, label in categories %}
          <option value="{{ val }}" {% if category == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-3 col-lg-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">All</option>
          <option value="expired" {% if status == 'expired' %}selected{% endif %}>Expired</option>
          <option value="low"     {% if status == 'low'     %}selected{% endif %}>Low Stock</option>
          <option value="out"     {% if status == 'out'     %}selected{% endif %}>Out of Stock</option>
        </select>
      </div>
      <div class="col-auto d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> Filter</button>
        {% if q or category or status %}
        <a href="{% url 'medicine_list' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x-lg"></i> Clear</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Table -->
<div class="table-wrapper">
  <div class="card-header">
    <span style="font-weight:600;">{{ medicines.count }} medicine{{ medicines.count|pluralize }}</span>
    <div class="d-flex gap-2 align-items-center" style="font-size:.75rem; color:var(--muted);">
      <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:4px;"></span>OK</span>
      <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--amber);margin-right:4px;"></span>Low</span>
      <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--rose);margin-right:4px;"></span>Expired / Out</span>
    </div>
  </div>

  {% if medicines %}
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Supplier</th>
          <th>Status</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for m in medicines %}
        <tr class="{% if m.is_expired %}row-expired{% elif m.is_out_of_stock %}row-out{% elif m.is_low_stock %}row-low{% endif %}">
          <td>
            <a href="{% url 'medicine_detail' m.pk %}" class="fw-500 text-decoration-none" style="color:var(--navy);">
              {{ m.name }}
            </a>
          </td>
          <td><span class="badge badge-navy">{{ m.get_category_display }}</span></td>
          <td>{{ m.stock }}</td>
          <td>${{ m.price }}</td>
          <td>
            {{ m.expiry_date }}
            {% if m.is_expired %}
            <br><small style="color:var(--rose); font-size:.7rem;"><i class="bi bi-exclamation-circle"></i> Expired</small>
            {% endif %}
          </td>
          <td style="color:var(--slate);">{{ m.supplier.name|default:"—" }}</td>
          <td>
            {% if m.is_expired %}
              <span class="badge badge-expired"><i class="bi bi-x-circle me-1"></i>Expired</span>
            {% elif m.is_out_of_stock %}
              <span class="badge badge-out">Out of Stock</span>
            {% elif m.is_low_stock %}
              <span class="badge badge-low"><i class="bi bi-exclamation me-1"></i>Low</span>
            {% else %}
              <span class="badge badge-ok"><i class="bi bi-check me-1"></i>OK</span>
            {% endif %}
          </td>
          <td style="text-align:right;">
            <div class="d-flex gap-1 justify-content-end">
              <a href="{% url 'medicine_detail' m.pk %}" class="action-btn action-view" data-tooltip="View"><i class="bi bi-eye"></i></a>
              <a href="{% url 'medicine_edit'   m.pk %}" class="action-btn action-edit" data-tooltip="Edit"><i class="bi bi-pencil"></i></a>
              <a href="{% url 'medicine_delete' m.pk %}" class="action-btn action-delete" data-tooltip="Delete"><i class="bi bi-trash"></i></a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon"><i class="bi bi-capsule"></i></div>
    <p>No medicines found. <a href="{% url 'medicine_add' %}">Add your first one.</a></p>
  </div>
  {% endif %}
</div>

{% endblock %}
